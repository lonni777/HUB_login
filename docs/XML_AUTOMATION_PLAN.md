# План автоматизації тестування XML-фідів (завантаження контенту)

Згідно з інструкцією «Завантаження контенту XML формат», поточним E2E-кодом у **HUB_login** (`tests-ts/e2e/`, `pages/XmlFeedPage.ts`) та кодом бекенду **kastaua-hub** (`C:\...\kastaua-hub-master`).

---

## Джерела з проєкту kastaua-hub (backend)

| Що | Шлях у hub |
|----|------------|
| Модель фіду, поля БД | `src/hub/api/feed/feed.clj` — `-select-q` (is_active, update_stock, update_price, update, offerid_as_hub_code, zero_stock_when_not_found тощо) |
| Ліміт 3 активні фіди | `src/hub/api/feed/feed.clj` — перевірка кількості `is_active` та ex-info "Неможливо підключити більше 3х фідів..." |
| API збереження фідів | `src/hub/api/handlers/supplier.clj` — `set-feeds`, схема `SupplierFeeds` (origin_url, is_active, update_stock, update_price, update, offerid_as_hub_code, zero_stock_when_not_found, price_type, file для мапінгу) |
| Валідація XML при додаванні | `src/hub/api/handlers/supplier.clj` — виклик `feed.parser/valid-feed?`; помилка "Помилка валідації xml структури фіду" |
| Форма фіду (чекбокси) | `src/hub/ui/feeds/viewsv2.cljs` — Checkbox для is_active, offerid_as_hub_code, ignore_description, zero_stock_when_not_found, update_price, update_stock, update |
| Скачування/завантаження мапінгу | `src/hub/ui/feeds/views.cljs` — GetMappingFile, FileInput "Завантажити ручний мапінг категорій"; API `gen-mapping-file`, `set-feeds` з file |
| Excel-мапінг (листи, Ignore_SKU) | `src/hub/api/feed/manual_mapping.clj` — prefix "ignore_sku|" для Ignore_SKU; `src/hub/api/feed/columnar_excel.clj` — читання листів |
| Unit-тести мапінгу Excel | `test/hub/api/feed/mappings_excel_test.clj` — листи "Категорія+", "Підказки категорій" |
| Репорти фідів | `src/hub/api/feed/report.clj` — звіти по feed_id; `src/hub/api/handlers/supplier.clj` — feed-reports (S3) |
| Оновлення цін/стоків | `src/hub/api/feed/stock_price_update.clj` — update_stock, update_price, zero_stock_when_not_found |

---

## Вже автоматизовано (E2E у HUB_login)

| Тест-сьют | Файл | Що покрито |
|-----------|------|------------|
| **Додавання та валідація XML** | `tests-ts/e2e/xml-feed.spec.ts` | Збереження валідного URL (https/http), нормалізація пробілів, валідація (порожнє поле, JSON замість XML, 404, ftp, без протоколу, некоректна структура), таймаут, чекбокс «Завантажити товари з xml», дубль URL, обмеження 3 активні фіди (відповідає `feed.clj`). |
| **Excel мапінг фідів** | `tests-ts/e2e/excel-mapping.spec.ts` | Скачування файлу ручного мапінгу та завантаження опрацьованого Excel (відповідає UI views.cljs та API set-feeds з file). |

---

## Рекомендовані тест-сьюти (повне покриття роботи з XML)

| № | Тест-сьют | Відповідність інструкції | Джерело в hub / коментар |
|---|-----------|--------------------------|---------------------------|
| 1 | **Додавання та валідація XML** *(існує)* | Розд. 2 | Покрито. Зміна URL існуючого фіду в UI неможлива — поле URL після першого збереження дізейблено (`viewsv2.cljs`: `is-new? (empty? saved)`, `:disabled (not is-new?)`). Перезбереження (тригер черги) — див. розділ нижче. |
| 2 | **Налаштування фіду (чекбокси)** | Розд. 2 | `viewsv2.cljs`: is_active, offerid_as_hub_code, ignore_description, zero_stock_when_not_found, update_price, update_stock, update. API `SupplierFeeds`. Перевірка збереження після перезаходу. |
| 3 | **Вимкнення фіду** | Розд. 2 | Видалення неможливе; вимкнення — зняти is_active («Завантажити товари з xml») і зберегти. Перевірка, що при вимкнених update_stock/update_price оновлення не йдуть (smoke). |
| 4 | **Мапінг: Категорія+ (Excel)** *(частково є)* | Розд. 3.1 | Hub: `mappings_excel_test.clj` перевіряє листи «Категорія+», «Підказки категорій». E2E: розширити — валідація структури скачаного xlsx, помилки при невалідному файлі. |
| 5 | **Мапінг: Каскад+ (характеристики, кольори)** | Розд. 3.2 | Завантаження Excel з мапінгом характеристик/кольорів; перевірка успішного прийому (відповідь API або відсутність помилки в UI). |
| 6 | **Мапінг: Розмірна сітка (Каскад+)** | Розд. 3.3 | Завантаження мапінгу з коректною розмірною сіткою; перевірка прийому. |
| 7 | **Мапінг: Конвертер+** | Розд. 3.4 | Excel з листом «Конвертер+»; валідація та прийом файлу. |
| 8 | **Мапінг: Ignore_SKU** | Розд. 3.5 | Hub: `manual_mapping.clj` — prefix "ignore_sku|". Вкладка Ignore_SKU у файлі; валідація дубля/порожнього offer_id; завантаження коректного файлу. |
| 9 | **Report завантажень** | Розд. 4 | Hub: `report.clj`, `supplier.clj` feed-reports (S3). E2E: на сторінці фіду — блок репорту (лічильники), посилання на повний лог; перевірка формату (наприклад Ignore_SKU у тексті). |
| 10 | **Оновлення цін та стоків (налаштування)** | Розд. 6 | Hub: `feed.clj` update_stock, update_price; `stock_price_update.clj`. E2E: увімкнути опції, зберегти, перевірити збереження галочок. |
| 11 | **Оновлення контенту (налаштування)** | Розд. 7 | Поле `update` у feed; увімкнути «Оновлювати контент», зберегти, перевірити. |
| 12 | **Помилки доступу (403, 404, 500)** | Розд. 9 | Після збереження фіду з URL 403/404/500 — перевірка відображення повідомлення в налаштуваннях/репорті (при наявності тестових URL або mock). |
| 13 | **Повторне збереження фіду** | Розд. 9 | Відкрити існуючий фід, «Зберегти» без змін — перевірка успіху та того, що фід потрапляє в чергу на оновлення (див. розділ «Поле URL… та перезбереження»). |
| 14 | **Таблиця фідів** | Розд. 2 | Заголовки (Лінк фіду, Підключено?, Останнє завантаження), фільтр по лінку, кнопка «Редагувати» → сторінка з правильним feed_id. |
| 15 | **Стоп-слова** | Розд. 8 | Hub: `supplier_content_stopwords_test.clj`. Якщо в UI є перевірка стоп-слів — тести; інакше ручна/бекенд. |

---

## Поле URL після збереження та перезбереження (тригер черги)

### Чому URL не можна змінити

Після **першого** збереження фіду поле вводу URL у формі робиться **тільки для читання** (disabled). У hub це реалізовано так:

- **Файл:** `src/hub/ui/feeds/viewsv2.cljs`
- Логіка: `is-new? (empty? saved)` — якщо є збережені дані фіду, форма вважається «існуючий фід».
- Поле URL: `(Input form saved :origin_url ... :disabled (not is-new?))` — для існуючого фіду `disabled = true`.

Тому сценарій «зміна URL існуючого фіду» в E2E не потрібен: користувач не може його змінити в інтерфейсі.

---

### Як працює перезбереження (тригер черги)

Коли користувач натискає **«Зберегти»** на вже існуючому фіді (без зміни файлу мапінгу):

1. **API** `set-feeds` (`src/hub/api/handlers/supplier.clj`) викликається з тілом (налаштування фіду) і **без** `file`. Фід уже існує, тому валідація URL не виконується; викликається `feed.feed/make-new-feed!` з тим самим `origin_url` і новими налаштуваннями.

2. **Оновлення запису фіду** (`src/hub/api/feed/feed.clj`):
   - `-new-feed-q` — це `INSERT ... ON CONFLICT (origin_url) DO UPDATE SET ...`, тобто оновлюються лише налаштування (is_active, update_stock, update_price тощо), **origin_url не змінюється**.
   - Потім виконується **`-set-updated-at-q`**: для цього фіду в БД встановлюються `updated_at = now()`, `modified_at = nil`, і прибирається одна з помилок у `last_load_summary`.

3. **Черга планувальника** (`src/hub/api/feed/scheduler.clj`):
   - Планувальник формує чергу фідів за полем **rank**.
   - Якщо у фіду **`last_run_at < updated_at`** (тобто фід «перезбережений» після останнього запуску), йому дається **найвищий пріоритет** (мінімальний rank, умовно «дуже старий» час), щоб він потрапив у чергу на найближчий запуск.
   - Звичайні фіди ранжуються за `now() - last_run_at` (хто давно не запускався — той раніше).

Отже: **перезбереження = оновлення `updated_at` → планувальник ставить фід на початок черги.**

Після того як **завдання фіду реально виконається**, у `src/hub/api/feed/report.clj` викликається `feed/set-last_run_at!` — оновлюється **`last_run_at`** (це і є «дата останнього завантаження» в інструкції).

---

### Як перевіряти в тестах

- **Зміна URL:** не перевіряємо — поля для зміни в UI немає.
- **Перезбереження та черга:**
  - **Що можемо стабільно перевірити в E2E:**  
    - Натискання «Зберегти» на сторінці існуючого фіду (без змін або зі зміною лише чекбоксів).  
    - Очікування успішного відгуку (наприклад, тост «Дані збережено!» або відсутність повідомлення про помилку).  
    - Можна додатково перевірити, що форма залишається на сторінці редагування фіду (редиректу на помилку немає).
  - **Що змінюється тільки після виконання завдання:**  
    - **«Дата останнього завантаження фіду»** у UI — це `last_run_at`. Вона оновлюється **після** того, як крону виконає завантаження фіду (орієнтовно до ±6 год за інструкцією). Тому одразу після натискання «Зберегти» ця дата в UI **не змінюється**.
  - **Історія запусків:**  
    - У UI користувач бачить одну «Дату останнього завантаження» та блок «Звіт товарів останнього завантаження» (лічильники, посилання на повний репорт). Окремих списків «всі запуски фіду» в інтерфейсі немає.  
    - У бекенді є таблиця **`feed_history`** (`feed.clj` — `take-feed-snapshot!`): туди можуть зберігатися снапи фіду; це не публічний API і не частина поточного UI.  
  - **Висновок для E2E:** тест «Повторне збереження фіду» достатньо будувати на перевірці успішного збереження (тост/відповідь) і відсутності помилки. Перевірку того, що фід дійсно потрапив у чергу і що змінилась «Дата останнього завантаження», у автоматичному E2E без очікування крону (години) або доступу до БД/внутрішніх API робити нереалістично; це можна покрити інтеграційними тестами або ручно.

---

## Підсумкова матриця покриття

| Бізнес-процес (інструкція) | Тест-сьют E2E | Статус |
|----------------------------|---------------|--------|
| 1. Підготовка даних для XML (теги) | — | Довідкова інформація |
| 2. Завантаження та валідація XML | Додавання та валідація XML | Є |
| 3.1 Мапінг Категорій (Категорія+) | Excel мапінг + Мапінг Категорія+ | Частково / розширити |
| 3.2 Мапінг характеристик (Каскад+) | Мапінг Каскад+ | Заплановано |
| 3.3 Мапінг Розмірної сітки | Мапінг Розмірна сітка | Заплановано |
| 3.4 Конвертер+ | Мапінг Конвертер+ | Заплановано |
| 3.5 Ignore_SKU | Мапінг Ignore_SKU | Заплановано |
| 4. Report завантажень | Report завантажень | Заплановано |
| 5. Модерація товарів | — | Окремий модуль |
| 6. Оновлення цін та стоків | Налаштування фіду + Оновлення цін/стоків | Заплановано |
| 7. Оновлення контенту | Оновлення контенту (налаштування) | Заплановано |
| 8. Список стоп-слів | Стоп-слова (за наявності UI) | За потреби |
| 9. Помилки (403, 404, 500) | Помилки доступу + Повторне збереження | Заплановано |
| 10. Нові бренди/категорії | — | Запит на moderator@kasta.ua |

---

## Рекомендований порядок реалізації

1. **Налаштування фіду (чекбокси)** — швидко покриває всі опції з розд. 2 (відповідає `viewsv2.cljs` та API).
2. **Report завантажень** — критично для перевірки результатів імпорту.
3. **Вимкнення фіду** — простий сценарій.
4. **Мапінг: Ignore_SKU та валідація Excel** — розширення існуючого excel-mapping; орієнтація на `manual_mapping.clj` та тести hub.
5. **Помилки доступу та повторне збереження** — стабільність роботи з фідом.
6. **Оновлення цін/стоків/контенту (налаштування)** — без очікування реального крону.
7. **Таблиця фідів** — фільтри та перехід на редагування.
8. **Каскад+, Конвертер+, Розмірна сітка** — після стабілізації Excel-мапінгу та репортів.

Нові тести додавати в `tests-ts/e2e/` (окремі spec-файли або блоки в `xml-feed.spec.ts` за доменом).
