# Репорти та артефакти (tests-ts)

Документ описує звіти та артефакти **лише для tests-ts** (TypeScript, Playwright). Структура проєкту: [PROJECT_STRUCTURE.md](PROJECT_STRUCTURE.md). Загальний огляд звітів: [TEST_REPORTS.md](TEST_REPORTS.md).

---

## 1. Єдиний формат репортів: Allure

**Практика:** У проєкті використовується лише **Allure Report** для перегляду результатів прогонів.

- Під час тестів результати пишуться в **`reports/allure-results/`** (сирі дані).
- Після прогону потрібно згенерувати HTML-звіт: результати з `allure-results` перетворюються в зручний звіт у **`reports/allure-report/`**.
- Перегляд **тільки через локальний сервер** (не file://), щоб дані коректно підвантажувались:
  1. Згенерувати: `npx allure-commandline@2 generate ../reports/allure-results -o ../reports/allure-report --clean`
  2. Запустити сервер: `npm run allure:open` (або `npx serve ../reports/allure-report -l 9753`)
  3. Відкрити в браузері: **http://localhost:9753/index.html**

Інші формати (HTML Playwright з timestamp, bug-report.txt) не використовуються — лише Allure.

---

## 2. Історія репортів: останні 3 прогони на тест-сьют

**Практика:** Для кожного тест-сьюту зберігається історія з **останніх 3 прогонів**.

- **Тест-сьют** — це один spec-файл: `login`, `xml-feed`, `excel-mapping`.
- Після прогону (наприклад, `npx playwright test e2e/login.spec.ts`) і генерації Allure-звіту скрипт ротації копіює `reports/allure-report/` у **`reports/history/<suite>/run_<timestamp>/`** і залишає тільки 3 останні папки для цього сьюту.
- Приклад структури:
  ```
  reports/
    allure-results/           # сирі результати останнього прогону
    allure-report/            # згенерований звіт останнього прогону
    history/
      login/
        run_20260218_143000/  # 3-й за давністю
        run_20260218_150000/  # 2-й
        run_20260218_160000/  # останній
      xml-feed/
        run_20260218_161000/
        ...
      excel-mapping/
        ...
  ```

**Як використовувати:** Після прогону тестів конкретного сьюту виконати:
```bash
cd tests-ts
npm run test -- e2e/login.spec.ts
npx allure-commandline@2 generate ../reports/allure-results -o ../reports/allure-report --clean
npm run allure:rotate -- login
```
Параметр `login` — назва сьюту (login, xml-feed, excel-mapping). Скрипт `allure:rotate` копіює поточний `allure-report` у `reports/history/login/run_<timestamp>` і видаляє зайві, залишаючи 3 останні.

---

## 3. Артефакти (скріншоти, відео, trace)

- **Скріншоти** зберігаються тільки при падінні тесту (`screenshot: 'only-on-failure'` у playwright.config).
- **Trace і відео** — тільки при першому retry (`trace: 'on-first-retry'`, `video: 'on-first-retry'`).
- Всі артефакти пишуться в **`test-results/`** (у корені репо). Папка в `.gitignore`, у репозиторій не комітиться.
- У CI можна додатково зберігати артефакти лише для впалих тестів і обмежувати кількість збережених прогонів (наприклад, останні 3).

---

## 4. Ізоляція даних: тести, що використовують фіксований фід (R3DV / TEST_EXISTING_FEED_ID)

**Де використовується:** Тільки в **excel-mapping.spec.ts** (обидва тести):
- «скачування та завантаження Excel файлу мапінгу»;
- «валідація структури Excel файлу мапінгу».

Ці тести відкривають сторінку редагування **існуючого** фіду (за `TEST_EXISTING_FEED_ID`, за замовчуванням R3DV), скачують Excel, перевіряють/завантажують його. Вони **не створюють** новий фід, тому cleanup — це повернення стану фіду через UI (вимкнути чекбокс + Зберегти) і видалення тимчасового файлу; виконується в `afterEach` навіть при fail.

**Альтернатива (ізоляція даних):** Замість фіксованого R3DV можна створювати тестовий фід один раз на сьют у `beforeAll` (так само як у тесті «збереження валідного URL»: додати фід, отримати feedId), використовувати його в обох тестах, і в `afterAll` видалити фід через БД (`deleteFeedById`). Тоді не потрібен попередньо створений фід у довкіллі; тести будуть незалежні від конкретного feed_id. Реалізація — за бажанням після погодження.
